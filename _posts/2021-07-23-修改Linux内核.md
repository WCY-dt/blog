---
layout: post
title:  "ä¿®æ”¹ Linux å†…æ ¸"
date:   2021-07-23 00:00:00 +0800
categories: å®éªŒ
tags: linux
comments: 1
mathjax: true
copyrights: åŸåˆ›
---

æœ¬æ–‡ä¸ºä¸œå—å¤§å­¦çš„ç¥–ä¼ æ“ä½œç³»ç»Ÿå®éªŒã€‚å®ç°å¦‚ä¸‹ä»»åŠ¡ï¼š
- å®éªŒ1ï¼šç¼–è¯‘å†…æ ¸ä»£ç 
- å®éªŒ2ï¼šæ–°å»ºç³»ç»Ÿè°ƒç”¨
- å®éªŒ3ï¼šå®ç°å¯ä»¥å±è”½è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨ hide åŠå¯ä»¥æ ¹æ®ç”¨æˆ·æ¥å±è”½è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨ hide_user_process

å®éªŒä½¿ç”¨ Fedora 7 è™šæ‹Ÿæœºç¯å¢ƒï¼Œæä¾› linux-2.6.21 å†…æ ¸æ–‡ä»¶ï¼Œå¯åœ¨[æ­¤å¤„](https://pan.seu.edu.cn:443/link/66FDE81F03535A828A8FD4A189D2598A)ä¸‹è½½ã€‚

# å®éªŒç›®çš„

ç†Ÿæ‚‰ Linux å†…æ ¸æ–‡ä»¶ç»“æ„ï¼Œå­¦ä¼šä¿®æ”¹ä¸å¢åŠ ç³»ç»Ÿè°ƒç”¨ï¼ŒæŒæ¡è¿›ç¨‹æ§åˆ¶å’Œè¿›ç¨‹ç®¡ç†ç›¸å…³å†…å®¹ã€‚

# å®éªŒ1 Linux å†…æ ¸ä»£ç åˆ†æ

ä¾æ¬¡æ‰§è¡Œå‘½ä»¤

```bash
cd Desktop
tar zxvf linux-2.6.21.tar.gz
cd linux-2.6.21
make mrproper
cp /boot/config-2.6.21-1.3194.fc7 ./config
make oldconfig
make all
su
make modules_install
make install
make headers_install
vi /boot/grub/menu.lst
```

å°†

```lst
hiddenmenu
```

æ³¨é‡Šæ‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

<img src="https://i.loli.net/2021/07/23/23gYdGDXbMnazB8.png" alt="image-20210719100533082" style="zoom:67%;" />

é‡å¯

```shell
reboot
```

çœ‹åˆ°å¼•å¯¼èœå•ã€‚

<img src="https://i.loli.net/2021/07/23/HaDr45hP8A9B1oe.png" alt="image-20210719102455338" style="zoom:67%;" />

é€‰æ‹© seuï¼Œç³»ç»Ÿæ­£å¸¸å¯åŠ¨ã€‚

<img src="https://i.loli.net/2021/07/23/bIZsvxrow5zaXqM.png" alt="image-20210719142803971" style="zoom:67%;" />

# å®éªŒ2 ï¼šæ–°å¢ç³»ç»Ÿè°ƒç”¨

`./arch/i386/kernel/syscall_table.S` æœ€åæ·»åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨

```c
.long sys_psta
```

`./include/linux/psta.h` ç¼–è¾‘å†…å®¹ä¸º

```c
#ifndef _LINUX_PSTA_H
#define _LINUX_PSTA_H

struct pinfo {
    int nice;
	pid_t pid;
	uid_t uid;
};
#endif
```

`./include/linux/Kbuild` æ·»åŠ ä¸€è¡Œå¤´æ–‡ä»¶

```
header-y += psta.h
```

`./kernel/psta.c` ç¼–è¾‘å†…å®¹ä¸º

```c
#include <linux/linkage.h>
#include <linux/types.h>
#include <linux/psta.h>
#include <linux/kernel.h>
asmlinkage int sys_psta(struct pinfo *buf) {
    printk("Hello world\n");
    return 0;
}
```

`./kernel/Makefile` å¢åŠ ç›®æ ‡æ–‡ä»¶ `psta.o`

```makefile
obj-y = psta.o sched.o fork.o exec_domain.o panic.o printk.o profile.o \
	    exit.o itimer.o time.o softirq.o resource.o \
	    sysctl.o capability.o ptrace.o timer.o user.o \
	    signal.o sys.o kmod.o workqueue.o pid.o \
	    rcupdate.o extable.o params.o posix-timers.o \
	    kthread.o wait.o kfifo.o sys_ni.o posix-cpu-timers.o mutex.o \
	    hrtimer.o rwsem.o latency.o nsproxy.o srcu.o
```

`./include/asm-i386/unistd.h` å¢åŠ å®

```c
#define __NR_psta 320
```

åŒæ—¶ï¼Œå°† `NR_syscalls` ä¿®æ”¹ä¸º 321

`./include/linux/syscalls.h` å¢åŠ å¤´æ–‡ä»¶

```c
#include <linux/psta.h>
```

å¹¶æŠŠå‡½æ•°çš„å®šä¹‰åŠ è¿›æ¥

```c
asmlinkage int sys_psta(struct pinfo *buf)
```

`./Makefile` ä¿®æ”¹å†…æ ¸ç¼–å·ä¸º seu2

```makefile
EXTRAVERSION = -seu2
```

ç„¶åé‡æ–°ç¼–è¯‘é‡å¯

```shell
make mrproper
cp /boot/config-2.6.21-1.3194.fc7 ./config
make oldconfig
make all
su
make modules_install
make install
make headers_install
reboot
```

çœ‹åˆ°å¼•å¯¼èœå•ã€‚

<img src="https://i.loli.net/2021/07/23/5gULVmAFlkNGCey.png" alt="image-20210721191655445" style="zoom:67%;" />

é€‰æ‹© seu2ï¼Œç³»ç»Ÿæ­£å¸¸å¯åŠ¨ã€‚

`./test.c` ç¼–è¾‘å†…å®¹ä¸º

```c
#include <sys/syscall.h>
#include <unistd.h>
#include <linux/psta.h>

int main()
{
    struct pinfo info;
    int ret = syscall(320,&info);
    return 0;
}
```

ç¼–è¯‘å¹¶è¿è¡Œï¼Œç„¶åæŸ¥çœ‹å†…æ ¸æ¶ˆæ¯åˆ—è¡¨

```shell
gcc -o test test.c -I/home/seu/Desktop/linux-2.6.21/usr/include
./test
dmesg
```

åœ¨å†…æ ¸æ—¥å¿—çš„æœ€åçœ‹åˆ°äº† `Hello world`

<img src="https://i.loli.net/2021/07/23/xPfb76snF32umSg.png" alt="image-20210721191946278" style="zoom: 67%;" />

# å®éªŒ3ï¼šLinuxè¿›ç¨‹ç®¡ç†åŠå…¶æ‰©å±•

åšä»¥ä¸‹ç¼–è¾‘ï¼š

./include/linux/sched.h

ä¿®æ”¹ `task_struct`

```c
int cloak;
```

---

./kernel/fork.c

ä¿®æ”¹ `copy_process`

```c
p->cloak = 0;
```

---

./fs/proc/base.c

æ·»åŠ è¯­å¥

```c
extern int hidden_flag;
```

åˆ›å»º `sys_hide` 

```c
asmlinkage int sys_hide(pid_t pid, int on){
    if (current->uid == 0){
        struct task_struct *task = find_task_by_pid(pid);
        if (on == 0 || hidden_flag == 0)
            task->cloak = 0;
        else
            task->cloak = 1;
        proc_flush_task(task);
    }
    return 0;
}
```

ä¿®æ”¹ `proc_pid_readdir` 

```c
if (hidden_flag == 0 &&
    proc_pid_fill_cache(filp,dirent,filldir,task,tgid)<0){
    put_task_struct(task);
    goto out;
}
if (hidden_flag == 1 && task->cloak == 0 &&
    proc_pid_fill_cache(filp, dirent, filldir, task, tgid) < 0){
    put_task_struct(task);
    goto out;
}
```

ä¿®æ”¹ `proc_pid_lookup`

```c
if (task->cloak == 1 && hidden_flag == 1)
    goto out;
```

åˆ›å»º `sys_hide_user_processes`

```c
asmlinkage int sys_hide_user_processes(uid_t uid, char *comm, int on){
    if (current->uid == 0){
        struct task_struct *task = NULL;
        for_each_process(task){
            char *s = task->comm;
            if (hidden_flag == 0 && task->uid == uid){ //judge hidden_flag
                task->cloak = 0;
            }
            else if (comm == NULL){ //hide all
                if (task->uid == uid){
                    task->cloak = on;
                }
            }
            else if (task->uid == uid && strcmp(s, comm) == 0){ //hide comm
                task->cloak = on;
            }
            proc_flush_task(task);
        }
    }
    return 0;
}
```

---

./fs/proc/proc_misc.c

æ·»åŠ ä»¥ä¸‹å˜é‡å’Œå‡½æ•°

```c
int hidden_flag = 0;
EXPORT_SYMBOL(hidden_flag);

static int proc_read_hidden(char *page, char **start,
                            off_t off, int count, int *eof, void *data)
{
    int len = 0;
    len = sprintf(page,"%d",hidden_flag);
    return len;
}

static int proc_write_hidden(struct file *file, const char *buffer,
                             unsigned long count, void *data)
{
    hidden_flag = buffer[0] - '0';
    return count;
}

static int proc_read_hidden_processes(char *page, char **start, off_t off,
                                      int count, int *eof, void *data){
    static char buf[1024*8]="";
    char tmp[128];
    struct task_struct *p;
    if (off>0)
        return 0;
    sprintf(buf,"%s","");
    for_each_process(p){
        if (p->cloak == 1){
            sprintf(tmp, "%d", p->pid);
            strcat(buf,tmp);
        }
    }
    sprintf(page, "%s", buf);
    return strlen(buf);
}
```

åœ¨ `proc_misc_init` æœ€åæ·»åŠ 

```c
struct proc_dir_entry *ptr = create_proc_entry("hidden", 0644, NULL);
ptr->read_proc = proc_read_hidden;
ptr->write_proc = proc_write_hidden;
struct proc_dir_entry *hideprocessfile =
    create_proc_entry("hidden_process", 0644, NULL);
hideprocessfile->read_proc=proc_read_hidden_processes;
```

`./arch/i386/kernel/syscall_table.S` æœ€åæ·»åŠ ç³»ç»Ÿè°ƒç”¨

```c
.long sys_hide
.long sys_hide_user_process
```

`./include/asm-i386/unistd.h` å¢åŠ å®

```c
#define __NR_hide 321
#define __NR_hide_user_processes 322
```

åŒæ—¶ï¼Œå°† `NR_syscalls` ä¿®æ”¹ä¸º 323

`./include/linux/syscalls.h` æŠŠå‡½æ•°çš„å®šä¹‰åŠ è¿›æ¥

```c
asmlinkage int sys_hide(pid_t pid, int on);
asmlinkage int sys_hide_user_processes(uid_t uid, char *comm, int on);
```

ç„¶åé‡æ–°ç¼–è¯‘é‡å¯

```shell
make mrproper
cp /boot/config-2.6.21-1.3194.fc7 ./config
make oldconfig
make all
su
make modules_install
make install
make headers_install
reboot
```

å¯åŠ¨ååœ¨ `/proc` æ–‡ä»¶å¤¹ä¸‹çœ‹åˆ°äº† hidden å’Œ hidden_process

<img src="https://i.loli.net/2021/07/23/CGlUKn8f17Akobx.png" alt="image-20210723002556399" style="zoom:67%;" />

åˆ›å»º 4 ä¸ªæµ‹è¯•æ–‡ä»¶

<img src="https://i.loli.net/2021/07/23/NyRDlOZ7f8YFxTr.png" alt="image-20210723005835398" style="zoom:67%;" />

å†…å®¹åˆ†åˆ«ä¸º

```c
//hideInit.c
#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include <sys/syscall.h>

int main()
{
    syscall(321, 1, 1);
    return 0;
}
```

```c
//recoverInit.c
#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include <sys/syscall.h>

int main()
{
    syscall(321, 1, 0);
    return 0;
}
```

```c
//hideRootInit.c
#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include <sys/syscall.h>

int main()
{
    syscall(322, 0, "init", 1);
    return 0;
}
```

```c
//hideRoot.c
#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include <sys/syscall.h>

int main()
{
    syscall(322, 0, NULL, 1);
    return 0;
}
```

åˆ†åˆ«ç¼–è¯‘

```shell
cd Desktop
gcc -o hideInit hideInit.c
gcc -o recoverInit recoverInit.c
gcc -o hideRootInit hideRootInit.c
gcc -o hideRoot hideRoot.c
```

ç„¶åè¿›è¡Œæµ‹è¯•

```shell
cd /proc
su
echo "1" > hidden
```

ç„¶å `top`

<img src="https://i.loli.net/2021/07/23/mzwTndEc3Nu5lsg.png" alt="image-20210723012202234" style="zoom:67%;" />

æµ‹è¯• `./hideInit`

<img src="https://i.loli.net/2021/07/23/kSiLh4PvY7cHfKm.png" alt="image-20210723012222790" style="zoom:67%;" />

æ²¡æœ‰æˆåŠŸã€‚

è¿›å…¥ root æƒé™é‡æ–°æµ‹è¯•

<img src="https://i.loli.net/2021/07/23/YV3WOUSZK84eksl.png" alt="image-20210723011848018" style="zoom:67%;" />

çœ‹åˆ° 1 å·è¿›ç¨‹æˆåŠŸå±è”½

æµ‹è¯• `./recoverInit`

<img src="C:/Users/83442/AppData/Roaming/Typora/typora-user-images/image-20210723012134601.png" alt="image-20210723012134601" style="zoom:67%;" />

init åˆå›æ¥äº†

æµ‹è¯• `./hideRootInit`

<img src="C:/Users/83442/AppData/Roaming/Typora/typora-user-images/image-20210723032656927.png" alt="image-20210723032656927" style="zoom:67%;" />

çœ‹åˆ° root çš„ init è¿›ç¨‹æˆåŠŸå±è”½

æµ‹è¯• `./hideRoot`

<img src="https://i.loli.net/2021/07/23/ahwtXxKRVnEZJul.png" alt="image-20210723025539500" style="zoom:67%;" />

<img src="https://i.loli.net/2021/07/23/9kXnWcP5S1bqJhf.png" alt="image-20210723033122281" style="zoom:67%;" />

çœ‹åˆ° root çš„è¿›ç¨‹å…¨éƒ¨è¢«å±è”½

ç¼–å†™ç¨‹åºè°ƒç”¨ `syscall(322, 0, NULL, 0);` æ¢å¤ hidden_processã€‚

ç„¶åä¿®æ”¹ hidden ä¸º 0

```shell
echo "0" > hidden
```

é‡æ–°æµ‹è¯• `./hideRoot`

<img src="C:/Users/83442/AppData/Roaming/Typora/typora-user-images/image-20210723034549262.png" alt="image-20210723034549262" style="zoom:67%;" />

å¯ä»¥çœ‹åˆ°ï¼Œå±è”½ä¸èµ·æ•ˆæœäº†ã€‚

# å®éªŒæ€»ç»“

æœ¬å®éªŒ 1 å’Œ 2 å¾ˆå®¹æ˜“ï¼Œä¾è‘«èŠ¦ç”»ç“¢å³å¯ã€‚å®éªŒ 3 å…¶å®ä¹Ÿä¸éš¾ï¼Œä½†æˆ‘åœ¨ hide_user_processes ä¸ŠèŠ±äº†æ•´æ•´ 5 ä¸ªå°æ—¶ï¼šå…ˆæ˜¯ `==` å†™æˆäº† `=`ï¼ŒæŸ¥ bug æŸ¥äº†ä¸¤ä¸ªå°æ—¶ï¼›ç„¶åï¼Œæœ¬åº”è¯¥æ¯”è¾ƒä¸¤ä¸ªæŒ‡é’ˆå†…å®¹çš„åœ°æ–¹ï¼Œæˆ‘å†™æˆäº†æ¯”è¾ƒä¸¤ä¸ªæŒ‡é’ˆï¼Œåˆ debug äº†ä¸¤ä¸ªå°æ—¶ğŸ˜­

é€šè¿‡æœ¬æ¬¡å®éªŒï¼Œç†Ÿæ‚‰äº† Linux å†…æ ¸æ–‡ä»¶ç»“æ„ï¼Œå­¦ä¼šäº†ä¿®æ”¹ä¸å¢åŠ ç³»ç»Ÿè°ƒç”¨ï¼ŒæŒæ¡äº†è¿›ç¨‹æ§åˆ¶å’Œè¿›ç¨‹ç®¡ç†ç›¸å…³å†…å®¹ã€‚

