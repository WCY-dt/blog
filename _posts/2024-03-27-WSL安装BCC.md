---
layout: post
title:  "【杂项】WSL安装BCC"
date:   2024-03-27 00:00:00 +0800
categories: 其它
tags: WSL
comments: 1
mathjax: true
copyrights: 原创
---

从去年就开始想办法在 WSL2 上安装 BCC，但无论是官方教程[^1]还是网上的其它解决方法[^2]都没能很好地解决问题。直到今天，在综合了一堆方案后，终于完美解决。下面是具体的步骤：

> **当前系统版本信息**
>
> ```powershell
> $ wsl --version
> WSL 版本： 2.2.1.0
> 内核版本： 5.15.150.1-2
> ```

1. 下载内核：

   ```shell
   git clone https://github.com/microsoft/WSL2-Linux-Kernel.git
   cd WSL2-Linux-Kernel
   ```

2. 安装必要工具：

   ```shell
   sudo apt install flex bison build-essential libelf-dev libncurses-dev libssl-dev
   ```

3. 复制配置文件：

   ```shell
   cp Microsoft/config-wsl .config
   ```

   在 `.config` 中修改以下选项：

   ```yaml
   CONFIG_BPF=y
   CONFIG_BPF_SYSCALL=y
   CONFIG_NET_CLS_BPF=m
   CONFIG_NET_ACT_BPF=m
   CONFIG_BPF_JIT=y
   CONFIG_HAVE_BPF_JIT=y
   CONFIG_HAVE_EBPF_JIT=y
   CONFIG_BPF_EVENTS=y
   CONFIG_IKHEADERS=m
   CONFIG_NET_SCH_SFQ=m
   CONFIG_NET_ACT_POLICE=m
   CONFIG_NET_ACT_GACT=m
   CONFIG_DUMMY=m
   CONFIG_VXLAN=m
   ```

4. 获取内核版本：

   ```shell
   export KERNELRELEASE=$(uname -r)
   ```

   编译：

   ```shell
   make KERNELRELEASE=$KERNELRELEASE -j 4
   make KERNELRELEASE=$KERNELRELEASE modules -j 4
   sudo make KERNELRELEASE=$KERNELRELEASE modules_install
   ```

5. 挂载：

   ```shell
   sudo mount -t debugfs debugfs /sys/kernel/debug
   ```

6. 确认安装成功：

   ```shell
   sudo opensnoop-bpfcc
   ```



[^1]: [https://github.com/iovisor/bcc/blob/master/INSTALL.md#ubuntu---binary](https://github.com/iovisor/bcc/blob/master/INSTALL.md#ubuntu---binary)
[^2]: [https://gist.github.com/MarioHewardt/5759641727aae880b29c8f715ba4d30f](https://gist.github.com/MarioHewardt/5759641727aae880b29c8f715ba4d30f)
