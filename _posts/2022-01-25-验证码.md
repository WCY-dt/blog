---
layout: post
title:  "验证码识别"
date:   2022-01-25 00:00:00 +0800
categories: security
tags: 验证码
comments: 1
mathjax: true
copyrights: 原创 未完待续
---

验证码识别

验证码种类繁多，花样百出。其中，文字验证码数量最多，也是最容易处理的。它的通常类型有字母、数字、符号、汉字的识别，以及四则运算验证码等变种。它们通常以图片的形式出现，而对于非图片的验证码，我们也通常会将它们转换为图片。

我们希望通过程序来自动识别验证码。这就离不开编写强大的 OCR 程序。不妨从简单的开始。

# 验证码识别的基本流程

我们直接拿这个网站作为例子。https://defendtheweb.net/playground/captcha1

选取这个网站是因为，它本身就是用来学习相关技术的。这方便我们练习，也不会产生一些纠纷。

## 获取

即将验证码图片保存到本地。一方面，我们需要在本地训练模型，另一方面，如果没有特殊情况，我们的验证码也会在本地处理。

我们使用 python requests 库来完成这一任务

```python
sess = requests.session()

sess.get("https://defendtheweb.net/playground/captcha1")
response = sess.get(
    "https://defendtheweb.net/extras/playground/captcha/captcha1.php")

with open("captcha.png", "wb") as fd:
    fd.write(response.content)
```

这个很简单，不再多说。

## 色彩降维

或者对于大部分情况来说，是黑白化。rgb 拥有 3 个维度的值（红、绿、蓝），对我们程序处理是不利的。而黑白化则能化为一个灰度值。

彩色转化为黑白会损失一些信息，但我们要做的是文字识别，文字与背景通常会有较大的对比度（这可以方便肉眼观察）。对于较为简单的验证码，我们可以采用有文字的地方就变成黑色，没有文字的地方变成白色——把灰度降维到了二值，这使得处理更加简单。

回到我们这个例子，可以看到背景是纯白的，文字是绿色的。但由于图像本身的压缩，文字边缘并不清晰，产生了少许其它颜色。例如在下图中，O 的边缘就有浅绿色。

<img src="C:/Users/83442/AppData/Roaming/Typora/typora-user-images/image-20220124172914916.png" alt="image-20220124172914916" style="zoom:50%;" />

如何区分呢？

文字不好按照同一种颜色提取，背景总可以吧。我们可以将所有纯白的地方设定为背景，其余默认为文字。我们来试试效果：

```python
WHITE = (255, 255, 255)
 
def distance(pixel, color):
    distance = 0
    for i in range(3):
        distance += pow(color[i] - pixel[i], 2)
    return distance
 
def is_not_white(pixel):
    distance_to_white = distance(pixel, WHITE)
    if distance_to_white > 0:
        return True
    return False
 
with open("captcha.png", "rb") as fd:
    p = ImageFile.Parser()
    p.feed(fd.read())
    image = p.close()
 
    img2 = image.copy()
    w, h = image.size
 
    for x in range(0, w):
        for y in range(0, h):
            if is_not_white(image.getpixel((x, y))):
                img2.putpixel((x, y), BLACK)
            else:
                img2.putpixel((x, y), WHITE)

    img2.save("captcha_clean.png")
```

原来的图是

<img src="C:/Users/83442/AppData/Roaming/Typora/typora-user-images/image-20220124173537569.png" alt="image-20220124173537569" style="zoom: 67%;" />

现在变成了

<img src="C:/Users/83442/AppData/Roaming/Typora/typora-user-images/image-20220124173606794.png" alt="image-20220124173606794" style="zoom:67%;" />

确实变成黑白了，但不少地方糊在了一起。

糊在一起对于人眼来说还勉强可以分辨，但对于电脑，就很麻烦了（我们后面会讲到糊在一起的验证码）。还记得刚刚看到的浅绿色吗？我们也许可以设定一个阈值，只有“不那么白”的地方也看作白色。

```python
WHITE = (255, 255, 255)
 
THRESHOLD = 35000
 
def distance(pixel, color):
    distance = 0
    for i in range(3):
        distance += pow(color[i] - pixel[i], 2)
    return distance
 
def is_not_white(pixel):
    distance_to_white = distance(pixel, WHITE)
    if distance_to_white > THRESHOLD:
        return True
    return False
```

现在的结果就好多了

<img src="C:/Users/83442/AppData/Roaming/Typora/typora-user-images/image-20220124174135174.png" alt="image-20220124174135174" style="zoom:67%;" />

## 切割

这里的切割分为两步，第一步是裁去整个验证码四周的空白（当然，这一步不做在这里也没什么问题）；第二步是把每一个文字单独提取出来保存为一张图片。

