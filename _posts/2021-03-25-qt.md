---
layout: post
title:  "Qt"
date:   2021-03-25 00:00:00 +0800
categories: toturial
tags: Qt C++
comments: 1
copyrights: 原创
recommend: true
---

Qt（/ˈkjuːt/）是一个跨平台的C++应用程序开发框架，广泛用于开发GUI程序。[^1]当然，它也可以编写诸如python等语言。本文主要介绍使用Qt结合C++的编程。

[toc]

# Qt入门

本着从实践出发的理念，我们首先设计制作一个**加法计算器**来了解Qt的基本操作与功能。

## 创建工程

打开Qt Creator，点击文件$\rightarrow$新建文件或项目，选择`Qt Widgets Application`

<img src="https://i.loli.net/2021/03/31/wZANt36y9TJWrLK.png" alt="image-20210331204755038" style="zoom:67%;" />

点击Choose…继续，填写工程名称和路径。这里我们工程的名字叫adder，路径自行选择。

<img src="https://i.loli.net/2021/03/31/oKO1HZVRfb4iJgv.png" alt="image-20210331205032618" style="zoom:67%;" />

然后点击下一步，直到如下界面，将classname改为adder。

<img src="https://i.loli.net/2021/03/31/R3N8xon9rEGFCcf.png" alt="image-20210331205338893" style="zoom:67%;" />

一路点击下一步，完成工程创建。

## UI设计

选择左侧窗口显示了我们工程里面的所有文件：

<img src="https://i.loli.net/2021/03/31/MeaI8gPrvnNf7TG.png" alt="image-20210331205618250" style="zoom:67%;" />

- `adder.pro`：工程文件
- `adder.h`：类的定义文件
- `adder.cpp`：类的实现文件
- `main.cpp`：主文件
- `adder.ui`：窗口设计文件

与普通c++程序相比，它仅仅多了一个.ui文件，这个文件可以让我们设计窗口。

双击`adder.ui`，进入设计界面。拖动左侧列表中的组件完成如下界面。

<img src="https://i.loli.net/2021/03/31/yjzYb6LCJdlmKMg.png" alt="image-20210331210333686" style="zoom:67%;" />

单击第一个Spin Box，在右侧的属性栏中将objectName改为add1。

<img src="https://i.loli.net/2021/03/31/hpkgeBcWzjFQyuS.png" alt="image-20210331210546113" style="zoom:67%;" />

同理，另一个Spin Box改为add2，Text Browser改为result。

## 程序编写与槽

我们想知道的是，刚刚设计的界面是如何与自己编写的程序关联的呢？

在`adder.h`中，有如下语句：

```cpp
private:
    Ui::adder *ui;
```

因此，我们可以认为界面中的控件就是Ui类的成员变量。

那么，我们如何通过程序改变这些成员变量呢？

Qt中的一个重要概念是<mark>信号槽</mark>，程序与界面的交互便是通过信号槽来传递。可以这么理解：ui界面是电灯，我们程序中的函数是控制界面的开关，那么信号槽便是连接二者的电线。

在加法计算器中，我们需要完成如下任务：在改变任何一个加数（add1、add2）的时候，读入两个输入值，并把计算结果输出到result。因此，我们创建两个函数，一个负责add1改变的时候进行计算，另一个则负责add2。

在`adder.h`加入两个函数的定义：

```cpp
#ifndef ADDER_H
#define ADDER_H

#include <QMainWindow>

QT_BEGIN_NAMESPACE
namespace Ui { class adder; }
QT_END_NAMESPACE

class adder : public QMainWindow
{
    Q_OBJECT

public:
    adder(QWidget *parent = nullptr);
    ~adder();

private:
    Ui::adder *ui;

    
private slots://创建信号槽
    void add1_valueChanged(int value);
    void add2_valueChanged(int value);
};
#endif // ADDER_H
```

并在`adder.cpp`中给出两个函数的实现：

```cpp
#include "adder.h"
#include "ui_adder.h"

adder::adder(QWidget *parent)
    : QMainWindow(parent)
    , ui(new Ui::adder)
{
    ui->setupUi(this);
}

adder::~adder()
{
    delete ui;
}

void adder::add1_valueChanged(int value)
{
    ui->result->setText(QString::number(value + ui->add2->value()));
}

void adder::add2_valueChanged(int value)
{
    ui->result->setText(QString::number(value + ui->add1->value()));
}
```

> 较旧版本的Qt Creator中，默认生成的ui接口是`Ui::adder ui;`而非`Ui::adder *ui;`，因此在函数实现的时候需要把`->`改为`.`，这是C++指针的知识，在此不再赘述。

还记得我们前面关于开关和电线的比喻吗？我们现在已经把开关和电线连接上了，接下来，我们来连接电线和界面，也就是关联控件和槽。

进入`adder.ui`文件，选中add1，点击箭头所示按钮。

<img src="https://i.loli.net/2021/03/31/rT1mBUKo8DR9fCj.png" alt="image-20210331213207594" style="zoom:67%;" />

按住add1，向下拖动一段距离再松开，弹出配置连接的对话框。选择`valueChanged(int)`，然后点击编辑

<img src="https://i.loli.net/2021/03/31/cR7ntMdGC5u2YFV.png" alt="image-20210331213859279" style="zoom:67%;" />

点击加号，把我们刚刚写的两个槽函数添加进来

<img src="https://i.loli.net/2021/03/31/YziXhN9aIwUOZfT.png" alt="image-20210331214114338" style="zoom:67%;" />

点击OK，回到配置连接界面。选择右侧的`add1_valueChanged(int)`，点击OK。

<img src="https://i.loli.net/2021/03/31/1n97SLeUbqy2NF8.png" alt="image-20210331214315034" style="zoom:67%;" />

相似的，我们设置好add2。

<img src="https://i.loli.net/2021/03/31/B2kxQTE7hrLiyP5.png" alt="image-20210331214559429" style="zoom:67%;" />

保存文件。按<kbd>ctrl</kbd>+<kbd>R</kbd>运行，即可看到成品。

至此，我们的加法计算器制作完成，同时，我们已经掌握了Qt的基本操作方法。接下来，我们将会讲解其他基础操作。



# Qt基础

## 多窗口

我们希望实现两个功能：打开新窗口后原窗口关闭、打开新窗口后原窗口不关闭。

举个例子，某数据库程序需要你登陆，因此弹出登录对话框，而原窗口不关闭；登陆后弹出数据库窗口，登录窗口关闭。

在上一节的界面中添加登录按钮，并修改名字为loginButton

<img src="https://i.loli.net/2021/03/31/edQ3OcHDnNICEto.png" alt="image-20210331223502222" style="zoom:67%;" />

下面添加新窗口。右键工程文件夹，选择Add New。

<img src="https://i.loli.net/2021/03/31/WXZTngOutbD5faG.png" alt="image-20210331223936782" style="zoom:67%;" />

选择Qt设计师界面类

<img src="https://i.loli.net/2021/03/31/Nk1yT4Kx6Vfd8Pi.png" alt="image-20210331224109981" style="zoom:67%;" />

选择Dialog with buttons

<img src="https://i.loli.net/2021/03/31/ButeW8vIV1YZaq6.png" alt="image-20210331224234993" style="zoom:67%;" />

不断点击下一步，完成创建。

创建完成后会自动跳转到设计界面，我们增加一个按钮，修改名字为backToMain

<img src="https://i.loli.net/2021/03/31/X6WxuaEz8YkAhwC.png" alt="image-20210331224549487" style="zoom:67%;" />

为该按钮添加槽，选择`clicker()`和`accept()`

<img src="https://i.loli.net/2021/03/31/OghUpdX1f3lPryH.png" alt="image-20210331224722621" style="zoom:67%;" />

这里需要说明的是，`accept()`是一个内置函数，其功能是关闭当前窗口并返回主窗口，因此我们不需要自己编写代码。

接下来编写程序

`main.cpp`

```cpp
#include "adder.h"
#include "dialog.h"

#include <QApplication>

int main(int argc, char *argv[])
{
    QApplication a(argc, argv);
    adder w;
    dialog dlg;
    if(dlg.exec() == QDialog::Accepted)//判断是否点击了按钮
    {
        w.show();
        return a.exec();
    }
    else return 0;//否则直接退出程序
}
```

`dialog.h`

```cpp
#ifndef DIALOG_H
#define DIALOG_H

#include <QDialog>

QT_BEGIN_NAMESPACE
namespace Ui { class dialog; }
QT_END_NAMESPACE

class dialog : public QDialog
{
    Q_OBJECT

public:
    dialog(QWidget *parent = nullptr);
    ~dialog();

private:
    Ui::dialog *ui;
};

#endif // DIALOG_H
```

`dialog.cpp`

```cpp
#include "dialog.h"
#include "ui_dialog.h"

dialog::dialog(QWidget *parent)
    : QDialog(parent)
    , ui(new Ui::dialog)
{
    ui->setupUi(this);
}

dialog::~dialog()
{
    delete ui;
}
```

然后运行即可看到效果。

> 如果出现`error: allocation of incomplete type`报错，则点击构建$\rightarrow$清理所有项目即可解决。[^2]

接下来，我们实现另一种多窗口的情况。

打开`adder.ui`，右击按钮，选择转到槽

<img src="https://i.loli.net/2021/03/31/gIwBeEUN35x9Yb8.png" alt="image-20210331231633317" style="zoom:67%;" />

选择`clicked()`，然后会自动跳转到代码编辑界面。

修改`adder.cpp`

```cpp
#include "adder.h"
#include "ui_adder.h"
#include <QDialog>//新增一个头文件

adder::adder(QWidget *parent)
    : QMainWindow(parent)
    , ui(new Ui::adder)
{
    ui->setupUi(this);
}

adder::~adder()
{
    delete ui;
}

void adder::add1_valueChanged(int value)
{
    ui->result->setText(QString::number(value + ui->add2->value()));
}

void adder::add2_valueChanged(int value)
{
    ui->result->setText(QString::number(value + ui->add1->value()));
}

void adder::on_loginButton_clicked()
{
    QDialog *dlg = new QDialog(this);
    dlg->show();
}
```

运行即可查看效果。

## 信号与槽

右键工程文件夹，选择Add New，选择Qt设计师界面类，模板选择`Dialog without Buttons`。

设计如下界面，其中，输入框为`Line Edit`。

<img src="https://i.loli.net/2021/03/31/RifcI1u3LnWzYXy.png" alt="image-20210331233705969" style="zoom:67%;" />

属性编辑器中将用户名后面的行编辑器的名称更改为 usrLineEdit ，密码后面的行编辑器为 pwdLineEdit ，登录按钮为 loginBtn ，退出按钮为 exitBtn 。

同时，用户名输入框的palceholderText属性改为“输入用户名”；密码输入框的echoMode属性改为Password，palceholderText属性改为“输入密码”。

我们先来设置退出按钮。点击界面下方的加号，选择如图所示

<img src="https://i.loli.net/2021/03/31/dvMSiwyaA8IBkHm.png" alt="image-20210331234321840" style="zoom:67%;" />

然后右击登录按钮，选择转到槽，然后选择`clicked()`信号。我们这里只是做一个示例，因此明文存储密码。修改函数为

```cpp
void Login::on_loginBtn_clicked()
{
    // 判断用户名和密码是否正确，如果错误则弹出警告对话框
    if(ui->usrLineEdit->text().trimmed() == tr("chenyang") &&
       ui->pwdLineEdit->text() == tr("123456"))
    {
        accept();
    }
    else
    {
        QMessageBox::warning(this, tr("Waring"),
                             tr("user name or password error!"),
                             QMessageBox::Yes);
        // 清空内容并定位光标
        ui->usrLineEdit->clear();
        ui->pwdLineEdit->clear();
        ui->usrLineEdit->setFocus();
     }
}
```

`main.cpp`修改为

```cpp
#include "adder.h"
#include "dialog.h"
#include "login.h"//新增头文件

#include <QApplication>

int main(int argc, char *argv[])
{
    QApplication a(argc, argv);
    adder w;
    Login dlg;//这里修改了
    if(dlg.exec() == QDialog::Accepted)
    {
        w.show();
        return a.exec();
    }
    else return 0;
}
```

运行即可观察到效果。

## 资源文件

我们首先设置菜单栏。

打开`adder.ui`，双击菜单栏的在这里输入，输入`文件(&F)`，回车后可以看到`&`被隐藏了。同理，再在二级菜单中创建`新建(&N)`。

<img src="https://i.loli.net/2021/04/01/zIUHl8PYFEJZTkg.png" alt="image-20210401001625097" style="zoom:67%;" />

然后我们新建Qt Resource File，名称为res，放到/res文件夹中。

因为我们准备存储图片，故添加/images前缀

<img src="https://i.loli.net/2021/04/01/wLtBgfocZjlT7au.png" alt="image-20210401002946450" style="zoom:67%;" />

将需要的图片粘贴进文件夹（图片可在[链接](https://www.jianguoyun.com/p/Db0i5icQ-KitCRjv6OoD)获取），然后返回该界面，点击add files，选择刚刚的图片，按<kbd>ctrl</kbd>+<kbd>S</kbd>保存。

<img src="https://i.loli.net/2021/04/01/lrNvFpnY8VXZ6oG.png" alt="image-20210401003556383" style="zoom:67%;" />

打开`adder.ui`，选择最下方的Action Editor，可以看到刚刚创建的“新建”菜单。双击进行设置。设置快捷键为<kbd>ctrl</kbd>+<kbd>N</kbd>；点击图标项旁的…按钮，点击选择资源，选择我们刚刚加入资源的图片。

<img src="https://i.loli.net/2021/04/01/4yZEXBCKPqIQ8MR.png" alt="image-20210401004118880" style="zoom:67%;" />

确认后运行，即可看到效果。

## 布局管理器

我们首先完善菜单栏

<center><img src="https://i.loli.net/2021/04/01/x4FbITkYA6emSzv.png" alt="image-20210401010038195" style="zoom:67%;" />  <img src="https://i.loli.net/2021/04/01/wXmFkDsRSKVegLp.png" alt="image-20210401010337996" style="zoom:67%;" /> <img src="https://i.loli.net/2021/04/01/rIO24RGoimyJeu7.png" alt="image-20210401010148085" style="zoom:67%;" /></center>

右键界面，点击添加工具栏。然后我们可以拖动Action Editor中的图标到工具栏

<img src="https://i.loli.net/2021/04/01/JuAUNiy6X2LFYRf.png" alt="image-20210401010828525" style="zoom:67%;" />

然后我学习布局管理器。从左边控件栏中拖入三个Push Button和一个Vertical Layout到界面上。然后将三个按钮拖入到布局管理器中，这时三个按钮就会自动垂直排列，并且进行水平拉伸，无论如何改变布局管理器的大小，按钮总是水平方向变化。

<img src="https://i.loli.net/2021/04/01/UAyqDLMuYOIZS9F.png" alt="image-20210401011056898" style="zoom:67%;" />

然后我们选择如图所示的按钮打破布局

<img src="https://i.loli.net/2021/04/01/yPjoZJ6RWIQnptr.png" alt="image-20210401011311672" style="zoom:67%;" />

选中3个按钮，使用分裂器垂直布局

<img src="https://i.loli.net/2021/04/01/lNrMgTd98wJoEGU.png" alt="image-20210401011529911" style="zoom:67%;" />

可以发现，使用分裂器按钮纵向是可以变大的，这就是分裂器和布局管理器的重要区别。

布局管理器除了可以对部件进行布局外，还可以使部件随着窗口的大小变化而变化。我们删除界面上的部件，然后拖入一个Text Edit。右键点击布局$\rightarrow$栅格布局，可以看到，无论怎样拉伸窗口，文本编辑器总是填充整个中央区域。

<img src="https://i.loli.net/2021/04/01/WehT2yvuji7cgNJ.png" alt="image-20210401012029857" style="zoom:67%;" />



# Qt实践

本节将会制作一个文本编辑器。实践部分**重点在于阅读代码**，故本节尽量减少讲解。

## 文本编辑

新建editor，并且把adder上的那个按钮设置成打开editor。editor界面如下所示：

<img src="https://i.loli.net/2021/04/01/ceDkuY5wfUvaz38.png" alt="image-20210401040428295" style="zoom:67%;" />

在ui界面右击图标，选择转到槽，选择`triggered()`

<img src="https://i.loli.net/2021/04/01/yaPi5cKYWqXUVCT.png" alt="image-20210401040724835" style="zoom:67%;" />

编写程序

`editor.h`

```cpp
#ifndef EDITOR_H
#define EDITOR_H

#include <QMainWindow>
#include <QCloseEvent>

namespace Ui {
class editor;
}

class editor : public QMainWindow
{
    Q_OBJECT

public:
    explicit editor(QWidget *parent = nullptr);
    ~editor();

private:
    Ui::editor *ui;

public:
    void newFile();   // 新建操作
    bool maybeSave(); // 判断是否需要保存
    bool save();      // 保存操作
    bool saveAs();    // 另存为操作
    bool saveFile(const QString &fileName); // 保存文件
    bool loadFile(const QString &fileName); // 加载文件

private slots:
    void on_action_N_triggered();//new

    void on_action_S_triggered();//save

    void on_action_A_triggered();//save as

    void on_action_O_triggered();//open

    void on_action_C_triggered();//close

    void on_action_E_triggered();//exit

    void on_action_Z_triggered();//undo

    void on_action_X_triggered();//cut

    void on_action_C_2_triggered();//copy

    void on_action_V_triggered();//paste

private:
    // 为真表示文件没有保存过，为假表示文件已经被保存过了
    bool isUntitled;
    // 保存当前文件的路径
    QString curFile;

protected:
    void closeEvent(QCloseEvent *event); // 关闭事件
};

#endif // EDITOR_H
```

`editor.cpp`

```cpp
#include "editor.h"
#include "ui_editor.h"
#include <QMessageBox>
#include <QPushButton>
#include <QFileDialog>
#include <QTextStream>

editor::editor(QWidget *parent) :
    QMainWindow(parent),
    ui(new Ui::editor)
{
    ui->setupUi(this);
    // 初始化文件为未保存状态
    isUntitled = true;
    // 初始化文件名为"未命名.txt"
    curFile = tr("未命名.txt");
    // 初始化窗口标题为文件名
    setWindowTitle(curFile);
}

editor::~editor()
{
    delete ui;
}

void editor::newFile()
{
   if (maybeSave()) {
       isUntitled = true;
       curFile = tr("未命名.txt");
       setWindowTitle(curFile);
       ui->textEdit->clear();
       ui->textEdit->setVisible(true);
   }
}

bool editor::maybeSave()
{
    // 如果文档被更改了
    if (ui->textEdit->document()->isModified()) {
    // 自定义一个警告对话框
       QMessageBox box;
       box.setWindowTitle(tr("警告"));
       box.setIcon(QMessageBox::Warning);
       box.setText(curFile + tr(" 尚未保存，是否保存？"));
       QPushButton *yesBtn = box.addButton(tr("是(&Y)"),
                        QMessageBox::YesRole);
       box.addButton(tr("否(&N)"), QMessageBox::NoRole);
       QPushButton *cancelBut = box.addButton(tr("取消"),
                        QMessageBox::RejectRole);
       box.exec();
       if (box.clickedButton() == yesBtn)
            return save();
       else if (box.clickedButton() == cancelBut)
            return false;
   }
   // 如果文档没有被更改，则直接返回true
   return true;
}

bool editor::save()
{
   if (isUntitled) {
       return saveAs();
   } else {
       return saveFile(curFile);
   }
}

bool editor::saveAs()
{
   QString fileName = QFileDialog::getSaveFileName(this,
                                         tr("另存为"),curFile);
   if (fileName.isEmpty()) return false;
   return saveFile(fileName);
}

bool editor::saveFile(const QString &fileName)
{
   QFile file(fileName);

   if (!file.open(QFile::WriteOnly | QFile::Text)) {

       // %1和%2分别对应后面arg两个参数，/n起换行的作用
       QMessageBox::warning(this, tr("多文档编辑器"),
                   tr("无法写入文件 %1：/n %2")
                  .arg(fileName).arg(file.errorString()));
       return false;
   }
   QTextStream out(&file);
   // 鼠标指针变为等待状态
   QApplication::setOverrideCursor(Qt::WaitCursor);
   out << ui->textEdit->toPlainText();
   // 鼠标指针恢复原来的状态
   QApplication::restoreOverrideCursor();
   isUntitled = false;
   // 获得文件的标准路径
   curFile = QFileInfo(fileName).canonicalFilePath();
   setWindowTitle(curFile);
   return true;
}

bool editor::loadFile(const QString &fileName)
{
   QFile file(fileName); // 新建QFile对象
   if (!file.open(QFile::ReadOnly | QFile::Text)) {
       QMessageBox::warning(this, tr("多文档编辑器"),
                             tr("无法读取文件 %1:\n%2.")
                             .arg(fileName).arg(file.errorString()));
       return false; // 只读方式打开文件，出错则提示，并返回false
   }
   QTextStream in(&file); // 新建文本流对象
   QApplication::setOverrideCursor(Qt::WaitCursor);
   // 读取文件的全部文本内容，并添加到编辑器中
   ui->textEdit->setPlainText(in.readAll());      QApplication::restoreOverrideCursor();

   // 设置当前文件
   curFile = QFileInfo(fileName).canonicalFilePath();
   setWindowTitle(curFile);
   return true;
}

void editor::on_action_N_triggered()
{
    newFile();
}

void editor::on_action_S_triggered()
{
    save();
}

void editor::on_action_A_triggered()
{
    saveAs();
}

void editor::on_action_O_triggered()
{
    if (maybeSave()) {
        QString fileName = QFileDialog::getOpenFileName(this);
        // 如果文件名不为空，则加载文件
        if (!fileName.isEmpty()) {
           loadFile(fileName);
           ui->textEdit->setVisible(true);
       }
    }
}

void editor::on_action_C_triggered()
{
    if (maybeSave()) {
       ui->textEdit->setVisible(false);
    }
}

void editor::on_action_E_triggered()
{
    // 先执行关闭操作，再退出程序
    // qApp是指向应用程序的全局指针
    on_action_C_triggered();
    qApp->quit();
}

void editor::on_action_Z_triggered()
{
    ui->textEdit->undo();
}

void editor::on_action_X_triggered()
{
    ui->textEdit->cut();
}

void editor::on_action_C_2_triggered()
{
    ui->textEdit->copy();
}

void editor::on_action_V_triggered()
{
    ui->textEdit->paste();
}

void editor::closeEvent(QCloseEvent *event)
{
   // 如果maybeSave()函数返回true，则关闭程序
   if (maybeSave()) {
       event->accept();
   } else {   // 否则忽略该事件
       event->ignore();
   }
}
```

## 状态栏

我们首先添加动作提示。

选中新建动作，然后在右面的属性编辑器中将其`toolTip`更改为“新建文件”

<img src="https://i.loli.net/2021/04/01/l2wZKG4zf9nUIpq.png" alt="image-20210401042713341" style="zoom:67%;" />

运行后，鼠标停留在图标上时会显示新建文件。

然后我们设置临时信息。

在`editor.cpp`构造函数添加

```cpp
ui->statusBar->showMessage(tr("欢迎使用chenyang的Qt示例软件！"), 2000);
```

页面下方将会显示该文字，并在2s后消失。



# Qt图形





# Qt网络





# Qt进阶

## 国际化



## 帮助





---

[^1]:引用自维基百科[https://zh.wikipedia.org/wiki/Qt](https://zh.wikipedia.org/wiki/Qt)
[^2]:参考自[https://www.pianshen.com/article/91181224814/](https://www.pianshen.com/article/91181224814/)



> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a>  
>
> **本文为[chenyang](https://github.com/WCY-dt)的原创文章，采用[CC-BY-NC-SA](http://creativecommons.org/licenses/by-nc-sa/4.0/)协议进行许可，仅允许在非商业性博客转载，转载时请将本段文字放在醒目位置。**

