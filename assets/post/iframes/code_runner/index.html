<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ch3nyang's Online Code Runner</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
    <style>
        /* Global reset and box-sizing */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* CSS custom properties for colors */
        :root {
            --primary: #f0835c;
            --secondary: #d74514;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --dark: #1a1a1a;
            --gray: #6c757d;
            --white: #ffffff;
        }

        /* Body styling */
        body {
            position: relative;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--dark);
            margin: 0;
            padding: 0;
            width: calc(100dvw - 10px);
            height: calc(100dvh - 10px);
            min-height: 300px;
            padding: 2px;
            overflow: auto;
        }

        /* Main container */
        .container {
            width: 100%;
            height: 100%;
            padding-top: 10px;
        }

        /* Content layout */
        .content {
            display: flex;
            flex-direction: row;
            width: 100%;
            height: 100%;
            gap: 10px;
        }

        .editor-section {
            position: relative;
            height: 100%;
            width: 60%;
        }

        .output-section {
            position: relative;
            height: 100%;
            width: 40%;
        }

        /* Language selector styling */
        .language-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .language-selector select {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            outline: 2px solid var(--primary);
            height: 26px;
            box-sizing: border-box;
        }

        /* Top controls layout */
        .top-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            height: 36px;
        }

        /* Code editor container */
        .code-editor-container {
            position: relative;
            width: 100%;
            height: calc(100% - 44px);
        }

        /* Code editor textarea styling */
        .code-editor {
            width: 100%;
            height: 100%;
            border: 2px solid var(--primary);
            border-radius: 6px;
            background-color: #f8f9fa;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            padding: 10px;
            resize: none;
            outline: none;
            tab-size: 4;
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: auto;
        }

        .code-editor:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgb(215, 69, 20, 0.3);
        }

        .code-editor::-webkit-scrollbar, .output-container::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        .code-editor::-webkit-scrollbar-thumb, .output-container::-webkit-scrollbar-thumb {
            background-color: var(--primary);
            border-radius: 2px;
        }

        .code-editor::-moz-scrollbar, .output-container::-moz-scrollbar {
            width: 4px;
            height: 4px;
        }

        .code-editor::-moz-scrollbar-thumb, .output-container::-moz-scrollbar-thumb {
            background-color: var(--primary);
            border-radius: 2px;
        }

        .code-editor::-ms-scrollbar, .output-container::-ms-scrollbar {
            width: 4px;
            height: 4px;
        }

        .code-editor::-ms-scrollbar-thumb, .output-container::-ms-scrollbar-thumb {
            background-color: var(--primary);
            border-radius: 2px;
        }

        /* Controls section */
        .controls {
            display: flex;
            justify-content: flex-end;
            margin: 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* Button base styles */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Run button specific styles */
        .btn-run {
            background: var(--primary);
            color: white;
        }

        .btn-run:hover {
            background: var(--secondary);
        }

        /* Refresh button specific styles */
        .btn-refresh {
            background: var(--gray);
            color: white;
        }

        .btn-refresh:hover {
            background: #5a6268;
        }

        /* Output container styling */
        .output-container {
            background-color: var(--dark);
            color: #ecf0f1;
            padding: 10px;
            border-radius: 6px;
            width: 100%;
            height: 100%;
            font-family: 'Consolas', 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
            overflow: auto;
        }

        /* Status message styling */
        .status {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 6px;
            margin: 10px;
            background-color: #f1f2f6;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status.loading {
            background-color: #fff9e6;
            color: var(--warning);
        }

        .status.success {
            background-color: #e6f7ee;
            color: var(--success);
        }

        .status.error {
            background-color: #fceae9;
            color: var(--danger);
        }

        /* Hidden class for visibility control */
        .hidden {
            display: none;
        }

        /* Responsive design for mobile devices */
        @media (max-width: 768px) {
            .top-controls {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
                height: auto;
            }

            .language-selector {
                width: 100%;
            }

            .controls {
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
                gap: 5px;
            }

            .btn {
                width: auto;
                flex: 1;
                justify-content: center;
            }

            .btn-refresh {
                font-size: 0;
                flex: 0 0 auto;
                gap: 0;
            }

            .btn-refresh i {
                font-size: 12px;
            }

            .code-editor-container {
                height: calc(100% - 69px);
            }
        }

        @media (max-width: 375px) {
            .content {
                flex-direction: column;
            }

            .editor-section {
                width: 100%;
                height: 60%;
            }

            .output-section {
                width: 100%;
                height: 40%;
            }
        }
    </style>
</head>
<body>
    <div class="container">

        <div class="content">
            <div class="editor-section">

                <div class="top-controls">
                    <div class="language-selector">
                        <select id="language-select" class="language-selector" aria-label="Select Language">
                            <option value="c">C</option>
                            <option value="cpp">C++</option>
                            <option value="go">Go</option>
                            <option value="haskell">Haskell</option>
                            <option value="java">Java</option>
                            <option value="javascript">JavaScript</option>
                            <option value="lua">Lua</option>
                            <option value="perl">Perl</option>
                            <option value="python" selected>Python</option>
                            <option value="ruby">Ruby</option>
                            <option value="rust">Rust</option>
                        </select>
                    </div>

                    <div class="controls">
                        <button id="run-btn" class="btn btn-run">
                            <i class="fas fa-play"></i> Run Code
                        </button>
                    </div>
                </div>

                <div class="code-editor-container">
                    <textarea id="code-editor" class="code-editor" spellcheck="false" aria-label="Code Editor"></textarea>
                </div>
            </div>

            <div class="output-section">
                <div id="output" class="output-container">Output will be displayed here...</div>

                <div id="status" class="status hidden">
                    <span id="status-text">Loading runtime...</span>
                </div>
            </div>
        </div>

    </div>

    <!-- Load Pyodide library -->
    <script defer src="https://cdn.jsdelivr.net/npm/pyodide@0.29.0/pyodide.min.js"></script>

    <script>
        // Global variables for Pyodide and editor state
        let pyodide;
        let currentLanguage = 'python';
        let codeEditor;
        let initialCode;
        let initialLanguage;

        // Example code snippets for different languages
        const examples = {
            c: {
                fibonacci: '/* C Fibonacci example */\n#include <stdio.h>\n\nvoid fibonacci(int n) {\n    int a = 0, b = 1, next, i;\n    printf("Fibonacci sequence (first 20):\\n");\n    for (i = 0; i < 20 && a < n; i++) {\n        printf("%d ", a);\n        next = a + b;\n        a = b;\n        b = next;\n    }\n    printf("\\n");\n}\n\nint main() {\n    fibonacci(10000);\n    return 0;\n}'
            },
            cpp: {
                fibonacci: '/* C++ Fibonacci example */\n#include <iostream>\n#include <vector>\n\nstd::vector<int> fibonacci(int n) {\n    std::vector<int> result;\n    int a = 0, b = 1;\n    while (a < n) {\n        result.push_back(a);\n        int next = a + b;\n        a = b;\n        b = next;\n    }\n    return result;\n}\n\nint main() {\n    std::cout << "Fibonacci sequence (first 20):\\n";\n    for (int num : fibonacci(10000)) {\n        std::cout << num << " ";\n    }\n    std::cout << "\\n";\n    return 0;\n}'
            },
            go: {
                fibonacci: '/* Go Fibonacci example */\npackage main\n\nimport (\n    "fmt"\n)\n\nfunc fibonacci(n int) []int {\n    result := []int{}\n    a, b := 0, 1\n    for a < n {\n        result = append(result, a)\n        a, b = b, a+b\n    }\n    return result\n}\n\nfunc main() {\n    fmt.Println("Fibonacci sequence (first 20):")\n    for i, num := range fibonacci(10000) {\n        if i >= 20 {\n            break\n        }\n        fmt.Print(num, " ")\n    }\n    fmt.Println()\n}'
            },
            haskell: {
                fibonacci: '-- Haskell Fibonacci example\nfibonacci :: Int -> [Int]\nfibonacci n = takeWhile (< n) fibs\n  where fibs = 0 : 1 : zipWith (+) fibs (tail fibs)\n\nmain :: IO ()\nmain = do\n    putStrLn "Fibonacci sequence (first 20):"\n    print $ take 20 (fibonacci 10000)'
            },
            java: {
                fibonacci: '/* Java Fibonacci example */\nclass Fibonacci {\n    public static void main(String[] args) {\n        System.out.println("Fibonacci sequence (first 20):");\n        int a = 0, b = 1;\n        for (int i = 0; i < 20 && a < 10000; i++) {\n            System.out.print(a + " ");\n            int next = a + b;\n            a = b;\n            b = next;\n        }\n        System.out.println();\n    }\n}'
            },
            javascript: {
                fibonacci: '// JavaScript Fibonacci example\nfunction fibonacci(n) {\n    const result = [];\n    let a = 0, b = 1;\n    while (a < n) {\n        result.push(a);\n        [a, b] = [b, a + b];\n    }\n    return result;\n}\n\nconsole.log("Fibonacci sequence (first 20):");\nconsole.log(fibonacci(10000).slice(0, 20));'
            },
            lua: {
                fibonacci: '-- Lua Fibonacci example\nfunction fibonacci(n)\n    local result = {}\n    local a, b = 0, 1\n    while a < n do\n        table.insert(result, a)\n        a, b = b, a + b\n    end\n    return result\nend\n\nprint("Fibonacci sequence (first 20):")\nlocal fibs = fibonacci(10000)\nfor i = 1, math.min(20, #fibs) do\n    io.write(fibs[i] .. " ")\nend\nprint()'
            },
            perl: {
                fibonacci: '# Perl Fibonacci example\nsub fibonacci {\n    my ($n) = @_;\n    my @result;\n    my ($a, $b) = (0, 1);\n    while ($a < $n) {\n        push @result, $a;\n        ($a, $b) = ($b, $a + $b);\n    }\n    return @result;\n}\n\nprint "Fibonacci sequence (first 20):\\n";\nmy @fibs = fibonacci(10000);\nprint join(" ", @fibs[0..19]), "\\n";'
            },
            python: {
                fibonacci: '# Python Fibonacci example\ndef fibonacci(n):\n    a, b = 0, 1\n    result = []\n    while a < n:\n        result.append(a)\n        a, b = b, a + b\n    return result\n\nprint("Fibonacci sequence (first 20):")\nprint(fibonacci(10000)[:20])'
            },
            ruby: {
                fibonacci: '# Ruby Fibonacci example\ndef fibonacci(n)\n    result = []\n    a, b = 0, 1\n    while a < n\n        result << a\n        a, b = b, a + b\n    end\n    result\nend\n\nputs "Fibonacci sequence (first 20):"\nputs fibonacci(10000).take(20).join(" ")'
            },
            rust: {
                fibonacci: '/* Rust Fibonacci example */\nfn fibonacci(n: u32) -> Vec<u32> {\n    let mut result = Vec::new();\n    let (mut a, mut b) = (0, 1);\n    while a < n {\n        result.push(a);\n        let next = a + b;\n        a = b;\n        b = next;\n    }\n    result\n}\n\nfn main() {\n    println!("Fibonacci sequence (first 20):");\n    for num in fibonacci(10000).iter().take(20) {\n        print!("{} ", num);\n    }\n    println!();\n}'
            }
        };

        // Compiler configurations for Wandbox API
        let compilers = {};

        const compilerOptions = {
            c: '',
            cpp: '',
            go: '',
            haskell: '',
            java: '',
            lua: '',
            perl: '',
            ruby: '',
            rust: ''
        };

        // Initialize Pyodide runtime
        async function initializePyodide() {
            try {
                pyodide = await loadPyodide({
                    indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.29.0/full/'
                });
                // console.log('Pyodide loaded successfully');
            } catch (error) {
                console.error('Failed to load Pyodide:', error);
            }
        }

        // Initialize the code editor textarea
        function initializeCodeEditor() {
            codeEditor = document.getElementById('code-editor');

            // console.log('Textarea editor initialized');
        }

        // Execute Python code using Pyodide
        async function runPythonCode(code) {
            try {
                await pyodide.runPythonAsync('import sys\nfrom io import StringIO\nold_stdout = sys.stdout\nsys.stdout = captured_output = StringIO()');

                await pyodide.runPythonAsync(code);

                const output = await pyodide.runPythonAsync('captured_output.getvalue()');

                await pyodide.runPythonAsync('sys.stdout = old_stdout');

                return output || 'Code executed successfully.';
            } catch (error) {
                throw new Error('Python error: ' + error.message);
            }
        }

        // Execute JavaScript code in a sandboxed environment
        async function runJavaScriptCode(code) {
            try {
                let output = '';
                const originalLog = console.log;
                console.log = (...args) => {
                    output += args.join(' ') + '\n';
                };

                const func = new Function(code);
                func();

                console.log = originalLog;
                return output || 'Code executed successfully.';
            } catch (error) {
                throw new Error('JavaScript error: ' + error.message);
            }
        }

        // Execute code using Wandbox API for compiled languages
        async function runWandboxCode(code, compiler, language) {
            try {
                let requestBody = {
                    code: code,
                    compiler: compiler,
                    options: '',
                    'compiler-option-raw': '',
                    'runtime-option-raw': ''
                };

                // Add language-specific options
                if (language === 'java') {
                    requestBody.save = true; // For Java, might need save option
                } else if (language === 'go') {
                    // Go might need specific options
                }

                const response = await fetch('https://wandbox.org/api/compile.json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    console.error('HTTP Error:', response.status, response.statusText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('Wandbox response for', language, ':', result);

                if (parseInt(result.status) === 0) {
                    return result.program_output || 'Code executed successfully.';
                } else {
                    const errorMsg = result.compiler_error || result.program_error || result.compiler_message || 'Compilation failed';
                    throw new Error(`Compilation failed: ${errorMsg}`);
                }
            } catch (error) {
                throw new Error('Wandbox error: ' + error.message);
            }
        }

        // Fetch available compilers from Wandbox API
        async function getWandboxCompilers() {
            try {
                const response = await fetch('https://wandbox.org/api/list.json');
                const compilers = await response.json();
                // console.log('Available Wandbox compilers:', compilers);
                return compilers;
            } catch (error) {
                console.error('Failed to fetch compilers:', error);
                return [];
            }
        }

        // Select the latest compiler for a language
        function selectCompiler(compilersList, includes, excludes) {
            const matching = compilersList.filter(c =>
                includes.every(i => c.name.includes(i)) &&
                excludes.every(e => !c.name.includes(e))
            );
            if (matching.length === 0) return null;

            // Helper function to parse and compare versions
            function compareVersions(a, b) {
                const parseVersion = (v) => {
                    const match = v.match(/(\d+(?:\.\d+)*)/);
                    return match ? match[1].split('.').map(Number) : [0];
                };
                const va = parseVersion(a);
                const vb = parseVersion(b);
                for (let i = 0; i < Math.max(va.length, vb.length); i++) {
                    const na = va[i] || 0;
                    const nb = vb[i] || 0;
                    if (na > nb) return 1;
                    if (na < nb) return -1;
                }
                return 0;
            }

            // Prefer HEAD versions first
            const heads = matching.filter(c => c.name.includes('head'));
            if (heads.length > 0) {
                heads.sort((a, b) => compareVersions(b.version, a.version));
                return heads[0].name;
            }

            // Otherwise, select the one with the highest version
            matching.sort((a, b) => compareVersions(b.version, a.version));
            return matching[0].name;
        }

        // Main function to run code based on selected language
        async function runCode() {
            const code = codeEditor.value;

            if (!code.trim()) {
                document.getElementById('output').textContent = 'Error: Please enter code';
                return;
            }

            const outputElement = document.getElementById('output');
            const status = document.getElementById('status');
            const statusText = document.getElementById('status-text');

            status.classList.remove('hidden');
            status.classList.add('loading');
            statusText.textContent = 'Running ' + currentLanguage.toUpperCase() + ' code...';
            outputElement.textContent = '';

            try {
                let output;
                if (currentLanguage === 'python') {
                    output = await runPythonCode(code);
                } else if (currentLanguage === 'javascript') {
                    output = await runJavaScriptCode(code);
                } else if (compilers[currentLanguage]) {
                    output = await runWandboxCode(code, compilers[currentLanguage], currentLanguage);
                } else {
                    output = 'Language not supported for execution';
                }

                outputElement.textContent = output;

                status.classList.remove('loading');
                status.classList.add('success');
                statusText.textContent = currentLanguage.toUpperCase() + ' code executed successfully!';

                setTimeout(() => {
                    status.classList.add('hidden');
                }, 2000);
            } catch (error) {
                console.error('Execution error:', error);
                outputElement.textContent = 'Execution error: ' + error.message;

                status.classList.remove('loading');
                status.classList.add('error');
                statusText.textContent = 'Execution failed: ' + error.message;
            }
        }

        // Load example code for the current language
        async function loadExample(exampleName) {
            if (examples[currentLanguage] && examples[currentLanguage][exampleName]) {
                const code = examples[currentLanguage][exampleName];
                codeEditor.value = code;
            } else {
                const errorMsg = '// ' + currentLanguage.toUpperCase() + ' example: ' + exampleName + '\n// Example not available';
                codeEditor.value = errorMsg;
            }
        }

        // Switch to a different programming language
        async function switchLanguage(lang) {
            currentLanguage = lang;
            document.getElementById('language-select').value = lang;
            await loadExample('fibonacci');
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            initializeCodeEditor();

            // Read URL parameters for language and code first
            const urlParams = new URLSearchParams(window.location.search);
            const langParam = urlParams.get('lang') || urlParams.get('language');
            const codeParam = urlParams.get('code');

            // Check if loaded in iframe
            const isInIframe = window.self !== window.top;

            if (isInIframe) {
                // Only disable language selector if a specific language is passed via URL
                if (langParam) {
                    document.getElementById('language-select').disabled = true;
                }

                // Add refresh button
                const controlsDiv = document.querySelector('.controls');
                const refreshBtn = document.createElement('button');
                refreshBtn.id = 'refresh-btn';
                refreshBtn.className = 'btn btn-refresh';
                refreshBtn.innerHTML = '<i class="fas fa-refresh"></i> Refresh';
                controlsDiv.prepend(refreshBtn);

                // Add event listener for refresh button
                refreshBtn.addEventListener('click', () => {
                    currentLanguage = initialLanguage;
                    document.getElementById('language-select').value = initialLanguage;
                    codeEditor.value = initialCode;
                });
            }

            if (langParam && ['c', 'cpp', 'go', 'haskell', 'java', 'javascript', 'lua', 'perl', 'python', 'ruby', 'rust'].includes(langParam)) {
                currentLanguage = langParam;
                document.getElementById('language-select').value = langParam;
            }

            initialLanguage = currentLanguage;

            // Disable languages except Python and JavaScript
            const languageSelect = document.getElementById('language-select');
            /*
            for (let option of languageSelect.options) {
                if (option.value !== 'python' && option.value !== 'javascript') {
                    option.disabled = true;
                }
            }
            */

            if (codeParam) {
                initialCode = decodeURIComponent(codeParam);
                codeEditor.value = initialCode;
            } else {
                initialCode = examples[currentLanguage].fibonacci;
                codeEditor.value = initialCode;
            }

            initializePyodide();
            const compilersList = await getWandboxCompilers();
            // Language to compiler configuration mapping
            const languageToCompilerConfig = {
                'c': { language: 'C', keywords: ['gcc', 'c'] },
                'cpp': { language: 'C++', keywords: ['gcc'] },
                'go': { language: 'Go', keywords: ['go'] },
                'haskell': { language: 'Haskell', keywords: ['ghc'] },
                'java': { language: 'Java', keywords: ['openjdk'] },
                'lua': { language: 'Lua', keywords: ['lua'] },
                'perl': { language: 'Perl', keywords: ['perl'] },
                'ruby': { language: 'Ruby', keywords: ['ruby'] },
                'rust': { language: 'Rust', keywords: ['rust'] }
                // python and javascript are handled separately, not via Wandbox
            };

            // Select the latest compiler for a language
            function selectCompiler(compilersList, config) {
                const matching = compilersList.filter(c =>
                    config.keywords.every(i => c.name.includes(i)) &&
                    (config.excludes || []).every(e => !c.name.includes(e))
                );
                if (matching.length === 0) return null;

                // Helper function to parse and compare versions
                function compareVersions(a, b) {
                    const parseVersion = (v) => {
                        const match = v.match(/(\d+(?:\.\d+)*)/);
                        return match ? match[1].split('.').map(Number) : [0];
                    };
                    const va = parseVersion(a);
                    const vb = parseVersion(b);
                    for (let i = 0; i < Math.max(va.length, vb.length); i++) {
                        const na = va[i] || 0;
                        const nb = vb[i] || 0;
                        if (na > nb) return 1;
                        if (na < nb) return -1;
                    }
                    return 0;
                }

                // Prefer HEAD versions first
                const heads = matching.filter(c => c.name.includes('head'));
                if (heads.length > 0) {
                    heads.sort((a, b) => compareVersions(b.version, a.version));
                    return heads[0].name;
                }

                // Otherwise, select the one with the highest version
                matching.sort((a, b) => compareVersions(b.version, a.version));
                return matching[0].name;
            }

            // Set compilers to latest versions based on mapping
            for (const lang in languageToCompilerConfig) {
                const config = languageToCompilerConfig[lang];
                config.excludes = lang === 'cpp' ? ['-c', '-pp'] : [];
                compilers[lang] = selectCompiler(compilersList, config);
            }

            document.getElementById('run-btn').addEventListener('click', runCode);

            document.getElementById('language-select').addEventListener('change', async (e) => {
                const lang = e.target.value;
                await switchLanguage(lang);
            });

            document.getElementById('run-btn').disabled = false;
        });
    </script>
</body>
</html>
